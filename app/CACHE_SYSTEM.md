# سیستم کش (Cache System)

## توضیحات کلی

این سیستم کش برای بهینه‌سازی درخواست‌های API و کاهش بار سرور طراحی شده است. داده‌ها به مدت **30 دقیقه** در حافظه کش می‌شوند.

## نحوه کارکرد

### 1. اولین درخواست
- کاربر صفحه شماره مجازی را باز می‌کند
- درخواست به `/api/prices/1` ارسال می‌شود
- کش خالی است، بنابراین درخواست به API خارجی ارسال می‌شود
- پاسخ پردازش و در کش ذخیره می‌شود
- داده‌ها به کاربر نمایش داده می‌شود

### 2. درخواست‌های بعدی (در 30 دقیقه)
- کاربر صفحه را دوباره باز می‌کند
- درخواست به `/api/prices/1` ارسال می‌شود
- کش بررسی می‌شود و داده موجود است
- داده از کش برگردانده می‌شود (بدون درخواست به API خارجی)
- سرعت بارگذاری بسیار سریع‌تر است

### 3. پس از 30 دقیقه
- کش منقضی می‌شود
- درخواست بعدی دوباره به API خارجی ارسال می‌شود
- داده جدید در کش ذخیره می‌شود

## فایل‌های مربوطه

### 1. `CacheService.ts`
- سرویس اصلی کش
- مدیریت ذخیره و بازیابی داده‌ها
- بررسی انقضای کش

### 2. `api/prices/[serviceId]/route.ts`
- API endpoint برای دریافت قیمت‌ها
- بررسی کش قبل از درخواست به API خارجی
- ذخیره پاسخ در کش

### 3. `useVirtualNumbers.ts`
- Hook برای دریافت داده‌های شماره مجازی
- نمایش پیام‌های کش در کنسول

### 4. `CacheDebug.tsx`
- کامپوننت debug برای مدیریت کش
- فقط در محیط development نمایش داده می‌شود

### 5. `api/cache/clear/route.ts`
- API برای پاک کردن کش
- مدیریت کش از طریق API

## ویژگی‌ها

### ✅ مزایا
- **کاهش بار سرور**: درخواست‌های کمتر به API خارجی
- **سرعت بالا**: بارگذاری سریع‌تر صفحات
- **صرفه‌جویی در پهنای باند**: کاهش ترافیک شبکه
- **تجربه کاربری بهتر**: کاهش زمان انتظار

### ⚙️ تنظیمات
- **TTL**: 30 دقیقه (قابل تغییر)
- **ذخیره‌سازی**: در حافظه (Memory)
- **کلید کش**: `prices_{serviceId}`

## نحوه استفاده

### بررسی وضعیت کش
```javascript
// در کنسول مرورگر
fetch('/api/cache/clear?key=prices_1')
  .then(res => res.json())
  .then(data => console.log(data));
```

### پاک کردن کش
```javascript
// پاک کردن کش خاص
fetch('/api/cache/clear?key=prices_1', { method: 'POST' })
  .then(res => res.json())
  .then(data => console.log(data));

// پاک کردن تمام کش
fetch('/api/cache/clear', { method: 'POST' })
  .then(res => res.json())
  .then(data => console.log(data));
```

## لاگ‌ها

### در کنسول سرور
- `📦 Cache hit for service 1` - داده از کش دریافت شد
- `🌐 Cache miss for service 1, fetching from API...` - داده از API دریافت شد
- `💾 Data cached for service 1 for 30 minutes` - داده در کش ذخیره شد

### در کنسول مرورگر
- `📦 Data loaded from cache` - داده از کش بارگذاری شد
- `🌐 Data loaded from API` - داده از API بارگذاری شد

## نکات مهم

1. **کش در حافظه**: با restart سرور، کش پاک می‌شود
2. **TTL قابل تنظیم**: می‌توان زمان انقضا را تغییر داد
3. **Debug mode**: کامپوننت debug فقط در development نمایش داده می‌شود
4. **Error handling**: در صورت خطا، داده‌های پیش‌فرض نمایش داده می‌شود

## تغییر TTL

برای تغییر زمان انقضای کش، در فایل `api/prices/[serviceId]/route.ts` خط زیر را تغییر دهید:

```typescript
// ذخیره در کش برای 30 دقیقه
cacheService.set(cacheKey, processedData, 30); // 30 = 30 دقیقه
```

## پاک کردن کش در production

برای پاک کردن کش در production، از API endpoint استفاده کنید:

```bash
curl -X POST "https://yourdomain.com/api/cache/clear?key=prices_1"
```
